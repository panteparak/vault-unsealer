# Primary CI Pipeline - Fast feedback using composite actions
# Phase 1: Parallel linting, unit tests, helm validation, security scan
# Phase 2: Docker build (after unit tests and linting pass)
# Phase 3: Parallel smoke tests and E2E tests (after successful build)
# Estimated Duration: 8-15 minutes (optimized with composite actions)

name: âœ¨ CI (New)

on:
  push:
    branches: [ main, develop, 'feat/*', 'fix/*', 'chore/*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker build step'
        required: false
        default: false
        type: boolean
      run_e2e:
        description: 'Run E2E tests'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GO_VERSION: "1.24"

# Required permissions for reusable workflows
permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write

# Prevent multiple runs on same PR
concurrency:
  group: ci-new-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Environment setup and validation
  setup:
    name: ðŸš€ Setup Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      go-version: ${{ steps.setup-env.outputs.go-version }}
      config-hash: ${{ steps.setup-env.outputs.config-hash }}
      vault-version: ${{ steps.setup-env.outputs.vault-version }}
      k3s-version: ${{ steps.setup-env.outputs.k3s-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup environment
        id: setup-env
        uses: ./.github/actions/setup
        with:
          go-version: "1.24"
          setup-docker: true
          cache-prefix: ci-primary

  # Code quality checks
  lint:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 5
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: âš™ï¸ Setup Go
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ needs.setup.outputs.go-version }}
          verify-modules: true

      - name: ðŸ§¹ Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --timeout=10m

  # Unit tests with coverage
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run unit tests
        uses: ./.github/actions/run-unit-tests
        with:
          coverage: true
          race-detection: true
          timeout: 10m
          upload-coverage: true
          go-version: ${{ needs.setup.outputs.go-version }}


  # E2E tests (run after build, parallel with smoke tests)
  e2e-tests:
    name: ðŸŒ E2E Tests
    runs-on: ubuntu-latest
    needs: [build, setup]
    if: (github.event.inputs.run_e2e == 'true' || github.ref == 'refs/heads/main') && needs.build.result == 'success'
    timeout-minutes: 25
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Log in to Container Registry
        if: needs.build.result == 'success'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          coverage: false
          timeout: 20m
          go-version: ${{ needs.setup.outputs.go-version }}
          vault-version: ${{ needs.setup.outputs.vault-version }}
          k3s-version: ${{ needs.setup.outputs.k3s-version }}
        env:
          # Pass the first image tag from the build step (newline-separated tags, take first line)
          OPERATOR_IMAGE_TAGS: ${{ needs.build.outputs.image-tags }}

  # Helm chart validation
  helm-validate:
    name: ðŸ“¦ Helm Validation
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Validate and package Helm chart
        uses: ./.github/actions/helm-validate
        with:
          chart-path: ./helm/vault-unsealer
          version: 0.0.0-ci-${{ github.run_number }}
          app-version: ${{ github.sha }}
          package-chart: true
          upload-artifacts: true

  # Docker build (conditional)
  build:
    name: ðŸ—ï¸ Build Image
    runs-on: ubuntu-latest
    needs: 
      - setup
      - unit-tests
      # - lint
    if: github.event.inputs.skip_build != 'true'
    timeout-minutes: 20
    outputs:
      image-tags: ${{ steps.build-image.outputs.image-tags }}
      image-digest: ${{ steps.build-image.outputs.image-digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Build Docker image
        id: build-image
        uses: ./.github/actions/build-image
        with:
          registry: ghcr.io
          image-name: ${{ github.repository }}
          platforms: linux/amd64,linux/arm64
          push: true
          go-version: ${{ needs.setup.outputs.go-version }}
          build-args: '["VAULT_VERSION=${{ needs.setup.outputs.vault-version }}"]'

  # Basic security scanning (quick checks only)
  security-quick:
    name: ðŸ”’ Security (Quick)
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run security scan
        uses: ./.github/actions/security-scan
        with:
          scan-type: code
          severity-threshold: HIGH
          fail-on-severity: CRITICAL
          upload-sarif: true
          go-version: ${{ needs.setup.outputs.go-version }}

  # Smoke tests against built image
  smoke-tests:
    name: ðŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: [build, setup]
    if: needs.build.result == 'success'
    timeout-minutes: 5
    services:
      vault:
        image: hashicorp/vault:${{ needs.setup.outputs.vault-version }}
        env:
          VAULT_DEV_ROOT_TOKEN_ID: ci-test-token
          VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
        ports:
          - 8200:8200
        options: --cap-add=IPC_LOCK
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ needs.setup.outputs.go-version }}

      - name: Wait for Vault readiness
        run: |
          echo "â³ Waiting for Vault to be ready..."
          timeout 60s bash -c 'until curl -sf http://localhost:8200/v1/sys/health; do sleep 2; done'
          echo "âœ… Vault is ready"

      - name: Test basic connectivity
        run: |
          echo "ðŸ§ª Testing basic Vault connectivity..."

          # Run basic connectivity tests
          go test -v -timeout=2m ./test/unit/vault \
            -run=TestBasicConnectivity \
            -tags=smoke
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: ci-test-token
          CI: true

      - name: Test built image (if available)
        if: needs.build.outputs.image-digest != ''
        run: |
          echo "ðŸ³ Testing built Docker image..."

          # Extract image reference
          IMAGE_TAG=$(echo "${{ needs.build.outputs.image-tags }}" | head -n1)

          # Pull the built image
          docker pull "$IMAGE_TAG"

          # Basic image smoke test
          docker run --rm --entrypoint="" "$IMAGE_TAG" /manager --version || \
          docker run --rm --entrypoint="" "$IMAGE_TAG" ls -la /manager

  # Status aggregation and quality gates
  ci-status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    needs:
      - setup
      - lint
      - unit-tests
      - e2e-tests
      - helm-validate
      - build
      - security-quick
      - smoke-tests
    if: always()
    outputs:
      overall-result: ${{ steps.evaluate.outputs.result }}
    steps:
      - name: Evaluate CI results
        id: evaluate
        run: |
          echo "ðŸ” Evaluating CI pipeline results..."

          # Check required jobs
          SETUP_STATUS="${{ needs.setup.result }}"
          LINT_STATUS="${{ needs.lint.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          HELM_STATUS="${{ needs.helm-validate.result }}"
          SECURITY_STATUS="${{ needs.security-quick.result }}"

          # Optional jobs
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          BUILD_STATUS="${{ needs.build.result }}"
          SMOKE_STATUS="${{ needs.smoke-tests.result }}"

          echo "ðŸ“Š Job Results:"
          echo "  Setup: $SETUP_STATUS"
          echo "  Lint: $LINT_STATUS"
          echo "  Unit Tests: $UNIT_STATUS"
          echo "  Helm Validate: $HELM_STATUS"
          echo "  Security Quick: $SECURITY_STATUS"
          echo "  E2E Tests: $E2E_STATUS (optional)"
          echo "  Build: $BUILD_STATUS (optional)"
          echo "  Smoke Tests: $SMOKE_STATUS (optional)"

          # Determine overall result
          FAILED_JOBS=""

          [[ "$SETUP_STATUS" == "failure" ]] && FAILED_JOBS="$FAILED_JOBS setup"
          [[ "$LINT_STATUS" == "failure" ]] && FAILED_JOBS="$FAILED_JOBS lint"
          [[ "$UNIT_STATUS" == "failure" ]] && FAILED_JOBS="$FAILED_JOBS unit-tests"
          [[ "$HELM_STATUS" == "failure" ]] && FAILED_JOBS="$FAILED_JOBS helm-validate"
          [[ "$SECURITY_STATUS" == "failure" ]] && FAILED_JOBS="$FAILED_JOBS security"

          # E2E failure is blocking only if it was explicitly requested and build succeeded
          if [[ "$E2E_STATUS" == "failure" && "${{ github.event.inputs.run_e2e }}" == "true" && "$BUILD_STATUS" == "success" ]]; then
            FAILED_JOBS="$FAILED_JOBS e2e-tests"
          fi

          # Build failure is not blocking for PRs
          if [[ "$BUILD_STATUS" == "failure" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            FAILED_JOBS="$FAILED_JOBS build"
          fi

          if [[ -n "$FAILED_JOBS" ]]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ CI FAILED - Failed jobs:$FAILED_JOBS"
            exit 1
          else
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… CI PASSED - All required jobs successful"
          fi

      - name: Generate CI summary
        if: always()
        run: |
          echo "## âœ¨ CI Pipeline Summary (New)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Go Version**: ${{ needs.setup.outputs.go-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Vault Version**: ${{ needs.setup.outputs.vault-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Duration | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Setup | ${{ needs.setup.result == 'success' && 'âœ…' || 'âŒ' }} | ~2min | Environment preparation |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} | ~3min | Code quality checks |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ…' || 'âŒ' }} | ~5min | With coverage |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Validate | ${{ needs.helm-validate.result == 'success' && 'âœ…' || 'âŒ' }} | ~2min | Chart validation |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-quick.result == 'success' && 'âœ…' || needs.security-quick.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ~5min | Quick security scan |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ…' || needs.build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ~8min | Multi-platform Docker |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result == 'success' && 'âœ…' || needs.smoke-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ~3min | Image validation |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ…' || needs.e2e-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ~15min | After build/main only |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add coverage info if available
          if [[ "${{ needs.unit-tests.outputs.coverage-percentage }}" != "" ]]; then
            echo "### ðŸ“Š Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Unit Test Coverage**: ${{ needs.unit-tests.outputs.coverage-percentage }}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Add security info if available
          if [[ "${{ needs.security-quick.outputs.vulnerabilities-found }}" != "" ]]; then
            echo "### ðŸ”’ Security Scan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Vulnerabilities Found**: ${{ needs.security-quick.outputs.vulnerabilities-found }}" >> $GITHUB_STEP_SUMMARY
            echo "**Critical**: ${{ needs.security-quick.outputs.critical-count }}" >> $GITHUB_STEP_SUMMARY
            echo "**High**: ${{ needs.security-quick.outputs.high-count }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Add performance metrics
          echo "### âš¡ Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Estimated Total Duration**: 8-15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "**Parallel Jobs**: 5-7 concurrent" >> $GITHUB_STEP_SUMMARY
          echo "**Reusable Components**: âœ… Using optimized workflows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ”— Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Test results and coverage reports" >> $GITHUB_STEP_SUMMARY
          echo "- Security scan results and SARIF files" >> $GITHUB_STEP_SUMMARY
          echo "- Helm chart package" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "- Docker image: \`${{ needs.build.outputs.image-tags }}\`" >> $GITHUB_STEP_SUMMARY
          fi

  # Comment on PR with results (if this is a PR)
  pr-comment:
    name: ðŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [ci-status, setup, unit-tests, security-quick, build]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - name: Comment PR with CI results
        uses: actions/github-script@v7
        with:
          script: |
            const ciResult = '${{ needs.ci-status.outputs.overall-result }}';
            const setupResult = '${{ needs.setup.result }}';
            const unitCoverage = '${{ needs.unit-tests.outputs.coverage-percentage }}';
            const securityResult = '${{ needs.security-quick.outputs.scan-result }}';
            const buildResult = '${{ needs.build.result }}';

            let message = `## âœ¨ CI Pipeline Results (New)\n\n`;

            if (ciResult === 'success') {
              message += `### âœ… All Checks Passed!\n\n`;
            } else {
              message += `### âŒ Some Checks Failed\n\n`;
            }

            message += `| Component | Status | Details |\n`;
            message += `|-----------|--------|----------|\n`;
            message += `| Overall | ${ciResult === 'success' ? 'âœ…' : 'âŒ'} | ${ciResult} |\n`;
            message += `| Setup | ${setupResult === 'success' ? 'âœ…' : 'âŒ'} | Environment prepared |\n`;

            if (unitCoverage) {
              message += `| Unit Tests | âœ… | Coverage: ${unitCoverage}% |\n`;
            }

            if (securityResult) {
              const secIcon = securityResult === 'pass' ? 'âœ…' : securityResult === 'warning' ? 'âš ï¸' : 'âŒ';
              message += `| Security | ${secIcon} | ${securityResult} |\n`;
            }

            if (buildResult === 'success') {
              message += `| Build | âœ… | Multi-platform image built |\n`;
            } else if (buildResult === 'skipped') {
              message += `| Build | â­ï¸ | Skipped |\n`;
            }

            message += `\n### ðŸ”— Quick Links\n`;
            message += `- [Workflow Run](${context.payload.pull_request.html_url}/checks)\n`;
            message += `- [Test Results](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;

            if (unitCoverage) {
              message += `- [Coverage Report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
            }

            message += `\n*This comment was generated by the new optimized CI pipeline âœ¨*`;

            // Find existing comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('CI Pipeline Results (New)')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: message
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }
