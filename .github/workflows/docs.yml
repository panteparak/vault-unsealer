name: Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'README.md'
      - 'api/**'
      - 'helm/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Go (for CRD generation)
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install controller-gen
        run: |
          GOBIN=$PWD/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0

      - name: Get version
        id: get_version
        run: |
          VERSION=$(cat VERSION 2>/dev/null || echo "dev")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building docs for version: $VERSION"

      - name: Generate CRDs for docs
        run: |
          mkdir -p docs-site/static/crds/ docs-site/static/manifests/
          ./bin/controller-gen crd:allowDangerousTypes=true paths="./api/..." output:crd:artifacts:config=docs-site/static/crds/

          # Copy additional manifests
          cp -r manifests/* docs-site/static/manifests/ 2>/dev/null || true
          cp -r examples/* docs-site/static/examples/ 2>/dev/null || true

          # Create CRD index
          cat > docs-site/static/crds/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>CRD Documentation</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                  h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                  .crd-file { margin: 15px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; border-radius: 5px; }
                  .crd-file h3 { margin-top: 0; color: #2c3e50; }
                  .crd-file a { color: #007bff; text-decoration: none; font-weight: 500; }
                  .crd-file a:hover { text-decoration: underline; }
                  pre { background: #f4f4f4; padding: 15px; overflow-x: auto; border-radius: 5px; }
                  .nav { margin-bottom: 30px; }
                  .nav a { color: #007bff; text-decoration: none; font-weight: 500; }
                  .nav a:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <div class="nav">
                  <a href="../index.html">‚Üê Back to Documentation Home</a>
              </div>
              <h1>Custom Resource Definitions (CRDs)</h1>
              <p>This directory contains the CRD definitions for the Vault Unsealer.</p>
              <p><strong>Version:</strong> ${{ steps.get_version.outputs.version }}</p>
          EOF

          # Add CRD files to index
          for crd_file in docs-site/static/crds/*.yaml; do
            if [ -f "$crd_file" ]; then
              filename=$(basename "$crd_file")
              # Extract kind from CRD if possible
              kind=$(grep -m1 "kind:" "$crd_file" | sed 's/.*kind: //' | tr -d '"' || echo "")
              echo "<div class='crd-file'>" >> docs-site/static/crds/index.html
              echo "<h3><a href='$filename'>$filename</a></h3>" >> docs-site/static/crds/index.html
              if [ -n "$kind" ]; then
                echo "<p><strong>Kind:</strong> $kind</p>" >> docs-site/static/crds/index.html
              fi
              echo "<p>Click to view the full CRD definition.</p>" >> docs-site/static/crds/index.html
              echo "</div>" >> docs-site/static/crds/index.html
            fi
          done

          echo "</body></html>" >> docs-site/static/crds/index.html

      - name: Create documentation site
        run: |
          mkdir -p docs-site/

          # Create main index.html
          cat > docs-site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Vault Unsealer Documentation</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background-color: #f5f7fa;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 0 20px;
                  }
                  header {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 60px 0;
                      margin-bottom: 40px;
                  }
                  .hero {
                      text-align: center;
                  }
                  .hero h1 {
                      font-size: 3em;
                      font-weight: 300;
                      margin-bottom: 10px;
                  }
                  .hero .subtitle {
                      font-size: 1.2em;
                      opacity: 0.9;
                      margin-bottom: 20px;
                  }
                  .version-badge {
                      background: rgba(255,255,255,0.2);
                      padding: 8px 16px;
                      border-radius: 20px;
                      display: inline-block;
                      font-weight: 500;
                  }
                  .grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 30px;
                      margin: 40px 0;
                  }
                  .card {
                      background: white;
                      padding: 30px;
                      border-radius: 12px;
                      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                      transition: all 0.3s ease;
                      border: 1px solid #e1e8ed;
                  }
                  .card:hover {
                      transform: translateY(-8px);
                      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
                  }
                  .card-icon {
                      font-size: 2.5em;
                      margin-bottom: 15px;
                  }
                  .card h3 {
                      color: #2c3e50;
                      margin-bottom: 15px;
                      font-size: 1.4em;
                  }
                  .card p {
                      color: #666;
                      margin-bottom: 20px;
                  }
                  .btn {
                      display: inline-block;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 12px 24px;
                      text-decoration: none;
                      border-radius: 6px;
                      transition: all 0.2s;
                      font-weight: 500;
                      margin-right: 10px;
                      margin-bottom: 10px;
                  }
                  .btn:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  }
                  .btn-secondary {
                      background: #6c757d;
                  }
                  .btn-secondary:hover {
                      background: #5a6268;
                      box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
                  }
                  .installation {
                      background: white;
                      padding: 30px;
                      border-radius: 12px;
                      margin: 30px 0;
                      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                  }
                  .installation h2 {
                      color: #2c3e50;
                      margin-bottom: 20px;
                      display: flex;
                      align-items: center;
                  }
                  .installation h2::before {
                      content: "üöÄ";
                      margin-right: 10px;
                      font-size: 1.2em;
                  }
                  pre {
                      background: #2d3748;
                      color: #e2e8f0;
                      padding: 20px;
                      border-radius: 8px;
                      overflow-x: auto;
                      font-size: 0.9em;
                      line-height: 1.5;
                  }
                  .features {
                      background: white;
                      padding: 40px;
                      border-radius: 12px;
                      margin: 40px 0;
                      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                  }
                  .features h2 {
                      text-align: center;
                      color: #2c3e50;
                      margin-bottom: 30px;
                      font-size: 2em;
                  }
                  .features-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 25px;
                  }
                  .feature {
                      text-align: center;
                      padding: 20px;
                  }
                  .feature-icon {
                      font-size: 2.5em;
                      margin-bottom: 15px;
                  }
                  footer {
                      background: #2c3e50;
                      color: white;
                      text-align: center;
                      padding: 40px 0;
                      margin-top: 60px;
                  }
                  footer a {
                      color: #3498db;
                      text-decoration: none;
                  }
                  footer a:hover {
                      text-decoration: underline;
                  }
                  .stats {
                      display: flex;
                      justify-content: center;
                      gap: 40px;
                      margin: 20px 0;
                      flex-wrap: wrap;
                  }
                  .stat {
                      text-align: center;
                  }
                  .stat-number {
                      font-size: 2em;
                      font-weight: bold;
                      color: #3498db;
                  }
                  @media (max-width: 768px) {
                      .hero h1 { font-size: 2em; }
                      .grid { grid-template-columns: 1fr; }
                      .stats { flex-direction: column; gap: 20px; }
                  }
              </style>
          </head>
          <body>
              <header>
                  <div class="container">
                      <div class="hero">
                          <h1>Vault Unsealer</h1>
                          <div class="subtitle">A Kubernetes operator for automatically unsealing HashiCorp Vault instances</div>
                          <div class="version-badge">Version ${{ steps.get_version.outputs.version }}</div>
                      </div>
                  </div>
              </header>

              <div class="container">
                  <div class="installation">
                      <h2>Quick Installation</h2>
                      <pre><code># Install via Helm (from source)
          helm install vault-unsealer ./helm/vault-unsealer \
            --namespace vault-system \
            --create-namespace

          # Or apply Kubernetes manifests directly
          kubectl apply -f manifests/crd.yaml
          kubectl apply -f manifests/rbac.yaml
          kubectl apply -f manifests/deployment.yaml</code></pre>
                  </div>

                  <div class="features">
                      <h2>Key Features</h2>
                      <div class="features-grid">
                          <div class="feature">
                              <div class="feature-icon">üîê</div>
                              <h4>Automatic Unsealing</h4>
                              <p>Automatically unseals Vault instances when they become sealed</p>
                          </div>
                          <div class="feature">
                              <div class="feature-icon">üìä</div>
                              <h4>Metrics & Monitoring</h4>
                              <p>Prometheus metrics for comprehensive observability</p>
                          </div>
                          <div class="feature">
                              <div class="feature-icon">üîÑ</div>
                              <h4>High Availability</h4>
                              <p>Supports multiple Vault instances and failover scenarios</p>
                          </div>
                          <div class="feature">
                              <div class="feature-icon">‚öôÔ∏è</div>
                              <h4>Configurable</h4>
                              <p>Flexible configuration via CRDs and Helm values</p>
                          </div>
                      </div>
                  </div>

                  <div class="grid">
                      <div class="card">
                          <div class="card-icon">üìö</div>
                          <h3>Documentation</h3>
                          <p>Comprehensive guides and API references to get you started quickly</p>
                          <a href="getting-started.html" class="btn">Getting Started</a>
                          <a href="ARCHITECTURE.html" class="btn btn-secondary">Architecture</a>
                      </div>

                      <div class="card">
                          <div class="card-icon">‚öôÔ∏è</div>
                          <h3>Custom Resources</h3>
                          <p>Explore CRD definitions and Kubernetes manifests for the operator</p>
                          <a href="static/crds/" class="btn">View CRDs</a>
                          <a href="static/manifests/" class="btn btn-secondary">Manifests</a>
                      </div>

                      <div class="card">
                          <div class="card-icon">üöÄ</div>
                          <h3>Examples</h3>
                          <p>Ready-to-use configuration examples and deployment scenarios</p>
                          <a href="examples.html" class="btn">View Examples</a>
                          <a href="static/examples/" class="btn btn-secondary">Download</a>
                      </div>

                      <div class="card">
                          <div class="card-icon">üîß</div>
                          <h3>Development</h3>
                          <p>Integration testing guides and development documentation</p>
                          <a href="INTEGRATION_TESTING.html" class="btn">Testing Guide</a>
                          <a href="REFACTORING_GUIDE.html" class="btn btn-secondary">Dev Docs</a>
                      </div>
                  </div>
              </div>

              <footer>
                  <div class="container">
                      <div class="stats">
                          <div class="stat">
                              <div class="stat-number">100%</div>
                              <div>Test Coverage</div>
                          </div>
                          <div class="stat">
                              <div class="stat-number">K8s</div>
                              <div>Native</div>
                          </div>
                          <div class="stat">
                              <div class="stat-number">OSS</div>
                              <div>Open Source</div>
                          </div>
                      </div>
                      <p>Built with ‚ù§Ô∏è for the Kubernetes and HashiCorp Vault community</p>
                      <p><a href="https://github.com/${{ github.repository }}">View on GitHub</a> |
                         <a href="https://github.com/${{ github.repository }}/issues">Report Issues</a> |
                         <a href="https://github.com/${{ github.repository }}/discussions">Discussions</a></p>
                  </div>
              </footer>
          </body>
          </html>
          EOF

      - name: Convert Markdown docs to HTML
        run: |
          # Install a simple markdown converter
          npm install -g marked

          # Convert markdown files to HTML
          for md_file in docs/*.md; do
            if [ -f "$md_file" ]; then
              filename=$(basename "$md_file" .md)
              title=$(head -n1 "$md_file" | sed 's/^# //' | sed 's/^## //')
              echo "Converting $md_file to $filename.html"

              cat > "docs-site/$filename.html" << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>$title - Vault Unsealer</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 40px 20px;
                      line-height: 1.6;
                      color: #333;
                      background-color: #fafbfc;
                  }
                  .nav {
                      background: white;
                      margin: -40px -20px 40px -20px;
                      padding: 20px;
                      border-bottom: 1px solid #e1e8ed;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .nav a {
                      color: #007bff;
                      text-decoration: none;
                      font-weight: 500;
                      display: inline-flex;
                      align-items: center;
                  }
                  .nav a:hover { text-decoration: underline; }
                  .nav a::before { content: "‚Üê"; margin-right: 8px; }
                  .content {
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  h1, h2, h3, h4, h5, h6 { color: #2c3e50; margin-top: 2em; margin-bottom: 0.5em; }
                  h1 { border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-top: 0; }
                  h2 { border-bottom: 1px solid #e1e8ed; padding-bottom: 5px; }
                  pre {
                      background: #2d3748;
                      color: #e2e8f0;
                      padding: 20px;
                      border-radius: 6px;
                      overflow-x: auto;
                      margin: 1.5em 0;
                      font-size: 0.9em;
                  }
                  code {
                      background: #f1f3f4;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-size: 0.9em;
                      color: #d73a49;
                  }
                  pre code { background: transparent; color: inherit; padding: 0; }
                  blockquote {
                      border-left: 4px solid #3498db;
                      margin: 1.5em 0;
                      padding-left: 1em;
                      color: #666;
                      font-style: italic;
                  }
                  table {
                      width: 100%;
                      border-collapse: collapse;
                      margin: 1.5em 0;
                  }
                  th, td {
                      border: 1px solid #ddd;
                      padding: 12px;
                      text-align: left;
                  }
                  th {
                      background-color: #f8f9fa;
                      font-weight: 600;
                  }
                  a { color: #007bff; }
                  a:hover { color: #0056b3; }
                  img { max-width: 100%; height: auto; }
                  .toc {
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 6px;
                      margin-bottom: 30px;
                  }
                  .toc h4 { margin-top: 0; }
              </style>
          </head>
          <body>
              <div class="nav">
                  <a href="index.html">Back to Documentation Home</a>
              </div>
              <div class="content">
          EOF

              marked "$md_file" >> "docs-site/$filename.html"
              echo "</div></body></html>" >> "docs-site/$filename.html"
            fi
          done

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: 'docs-site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
